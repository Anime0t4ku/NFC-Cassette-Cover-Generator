name: NFC-Cassette-Cover-Generator

on: [push, pull_request]

permissions:
  contents: write

jobs:

  # =====================================================
  # Windows Build
  # =====================================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
      - name: Checkout branch
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install dependencies
        working-directory: nfc-cassette-cover-generator
        run: |
          python -m pip install --upgrade pip
          pip install pillow requests
          pip install pyinstaller

      - name: Build Windows executable
        shell: cmd
        working-directory: nfc-cassette-cover-generator
        run: pyinstaller --clean nfc-cassette-cover-generator.py --onefile --noconsole --add-data "icon.png;." --add-data "assets;assets" --icon app.ico

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v6
        with:
          name: NFC-Cassette-Cover-Generator-Windows-x86_64
          path: nfc-cassette-cover-generator/dist/

  # =====================================================
  # Release
  # =====================================================
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build-windows
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist

      - name: Create Windows ZIP
        run: |
          cd dist/NFC-Cassette-Cover-Generator-Windows-x86_64
          zip -r ../../NFC-Cassette-Cover-Generator-Windows-x86_64.zip .

      - name: Update Git Tag
        run: |
          git tag -f Pre-release
          git push -f origin Pre-release

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          prerelease: true
          allowUpdates: true
          removeArtifacts: true
          tag: Pre-release
          artifacts: |
            NFC-Cassette-Cover-Generator-Windows-x86_64.zip